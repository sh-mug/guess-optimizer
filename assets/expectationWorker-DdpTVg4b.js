(function(){"use strict";function u(t){return t*Math.PI/180}function d(t,a,n,o){const s=u(n-t),e=u(o-a),c=u(t),l=u(n),L=Math.sin(s/2),i=Math.sin(e/2),g=L*L+Math.cos(c)*Math.cos(l)*i*i;return 6371*(2*Math.atan2(Math.sqrt(g),Math.sqrt(1-g)))}function f(t,a,n,o){if(n.length===0)return 0;const s=1/n.length;let e=0;for(const c of n){const l=d(t,a,c.lat,c.lng);e+=Math.exp(-o*l)}return 5e3*s*e}function y(t,a,n={}){if(t.length===0)return null;const o=Math.max(n.samplesLat??30,1),s=Math.max(n.samplesLng??30,1),e=n.bbox??t.reduce((m,r)=>({minLat:Math.min(m.minLat,r.lat),maxLat:Math.max(m.maxLat,r.lat),minLng:Math.min(m.minLng,r.lng),maxLng:Math.max(m.maxLng,r.lng)}),{minLat:t[0].lat,maxLat:t[0].lat,minLng:t[0].lng,maxLng:t[0].lng}),c=o===1?0:(e.maxLat-e.minLat)/(o-1),l=s===1?0:(e.maxLng-e.minLng)/(s-1);let L=-1/0,i=e.minLat,g=e.minLng;for(let m=0;m<o;m++){const r=e.minLat+c*m;for(let h=0;h<s;h++){const x=e.minLng+l*h,M=f(r,x,t,a);M>L&&(L=M,i=r,g=x)}}return{bestLat:i,bestLng:g,bestScore:L}}const p=t=>t.map((a,n)=>({...a,id:`p-${n}`}));function b(t){try{if(t.type==="computeBest")return{type:"bestResult",result:y(p(t.points),t.K)};if(t.type==="computeHeatmap"){const a=[],{grid:n}=t,o=p(t.points);for(let s=n.minLat;s<=n.maxLat+1e-9;s+=n.stepLat)for(let e=n.minLng;e<=n.maxLng+1e-9;e+=n.stepLng){const c=f(s,e,o,t.K);a.push({lat:s,lng:e,value:c})}return{type:"heatmapResult",samples:a}}}catch(a){return{type:"error",message:a.message}}return{type:"error",message:"Unknown request type"}}self.onmessage=t=>{const a=b(t.data);self.postMessage(a)}})();
